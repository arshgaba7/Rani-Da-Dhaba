{% extends "base.html" %}

{% block content %}

<h1>Kitchen – Live Orders</h1>
<p class="page-subtitle">
    New orders appear here. You can accept the whole order or reject specific items before confirming.
</p>

<div class="card">
    <div class="card-header">
        <span>Active orders</span>
        <span class="pill">Status: new → confirmed → done</span>
    </div>

    <div id="orders-container">
        <div class="empty-state">Loading orders…</div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const container = document.getElementById("orders-container");

    function statusBadge(status) {
        if (status === "new") {
            return '<span class="pill" style="background:#ffebee;color:#b71c1c;">NEW</span>';
        } else if (status === "confirmed") {
            return '<span class="pill" style="background:#e8f5e9;color:#1b5e20;">CONFIRMED</span>';
        } else {
            return '<span class="pill">' + status + '</span>';
        }
    }

    function renderOrders(orders) {
        if (!orders || orders.length === 0) {
            container.innerHTML = '<div class="empty-state">No active orders right now.</div>';
            return;
        }

        let html = "";
        orders.forEach(order => {
            html += `
              <div class="order-card card" data-order-id="${order.id}">
                  <div class="order-title">
                      Order #${order.id}
                      &nbsp; ${statusBadge(order.status)}
                  </div>
                  <div class="order-meta">
                      ${order.customer_name || "Guest"} — ${order.table || "No table"}
                      • Placed at ${order.created_at || ""}
                  </div>

                  <div style="margin-top:8px;font-size:14px;font-weight:600;">Items:</div>
                  <ul style="margin:4px 0 10px 18px;font-size:14px;">
            `;

            order.items.forEach(item => {
                const itemLabel = `${item.category_name} — ${item.qty} × ${item.name}`;
                if (order.status === "new") {
                    // allow rejecting items only when status is new
                    html += `
                      <li>
                        <label>
                            <input type="checkbox"
                                   class="reject-checkbox"
                                   data-order-id="${order.id}"
                                   data-item-id="${item.id}">
                            Reject &nbsp;
                        </label>
                        ${itemLabel}
                      </li>
                    `;
                } else {
                    // confirmed orders, just show text
                    html += `<li>${itemLabel}</li>`;
                }
            });

            html += `
                  </ul>
                  <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
            `;

            if (order.status === "new") {
                html += `
                    <button class="btn btn-small"
                            onclick="confirmOrder(${order.id})">
                        Confirm order
                    </button>
                `;
            }

            // "Mark done" for both new + confirmed (you can restrict to confirmed if you want)
            html += `
                    <button class="btn btn-small btn-success"
                            onclick="markDone(${order.id})">
                        Mark as done
                    </button>
                  </div>
              </div>
            `;
        });

        container.innerHTML = html;
    }

    window.loadOrders = function () {
        fetch("/api/orders")
            .then(resp => resp.json())
            .then(data => renderOrders(data))
            .catch(err => {
                console.error(err);
                container.innerHTML = '<div class="empty-state">Error loading orders.</div>';
            });
    };

    window.markDone = function (orderId) {
        fetch(`/api/orders/${orderId}/done`, {
            method: "POST"
        })
        .then(resp => resp.json())
        .then(() => loadOrders())
        .catch(err => console.error(err));
    };

    window.confirmOrder = function (orderId) {
        // gather rejected items for this order
        const checkboxes = document.querySelectorAll(
            `.reject-checkbox[data-order-id="${orderId}"]:checked`
        );
        const rejectedIds = Array.from(checkboxes).map(cb => cb.getAttribute("data-item-id"));

        fetch(`/api/orders/${orderId}/confirm`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ rejected_item_ids: rejectedIds })
        })
        .then(resp => resp.json())
        .then(data => {
            console.log("confirm result", data);
            loadOrders();
        })
        .catch(err => console.error(err));
    };

    // initial load
    loadOrders();
    // periodic refresh
    setInterval(loadOrders, 4000);
});
</script>

{% endblock %}
